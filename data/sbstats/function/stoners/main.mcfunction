execute at @a[advancements={sbstats:villager=true}] at @e[tag=reforge,limit=1,sort=nearest] positioned ~ ~1 ~ as @e[type=item,nbt={Item:{components:{"minecraft:custom_data":{Base:{type:'UPGRADE'}}}}},nbt=!{Item:{components:{"minecraft:custom_data":{Base:{id:'RECOMBOBULATOR_3000'}}}}},distance=..0.8,limit=1] run data modify storage sbstats:stone SelectedItem set from entity @s Item
execute at @a[advancements={sbstats:villager=true}] at @e[tag=reforge,limit=1,sort=nearest] positioned ~ ~1 ~ as @e[type=item,nbt={Item:{components:{"minecraft:custom_data":{Base:{type:'UPGRADE'}}}}},nbt=!{Item:{components:{"minecraft:custom_data":{Base:{id:'RECOMBOBULATOR_3000'}}}}},distance=..0.8,limit=1] run function sbstats:stats/remove_item
execute at @s run playsound block.anvil.use master @s ~ ~ ~

data modify storage sbstats:data oldnametmp.oldname set from entity @s SelectedItem.components."minecraft:item_name"
execute if data storage sbstats:data {PlayerData:{SelectedItem:{components:{"minecraft:custom_data":{Upgrades:{reforged:1b}}}}}} run function sbstats:macros/old_name with storage sbstats:data oldnametmp

data modify storage sbstats:item_name Name set from storage sbstats:data PlayerData.SelectedItem.components."minecraft:custom_data".SBStats.OldName
data modify storage sbstats:reforge Name set from storage sbstats:data PlayerData.SelectedItem.components."minecraft:custom_data".Upgrades.reforge.type
item modify entity @s weapon.mainhand sbstats:custom_stone

execute if data storage sbstats:data {PlayerData:{SelectedItem:{components:{"minecraft:custom_data":{Base:{rarity:'COMMON'}}}}}} run data modify storage sbstats:stone Item.components."minecraft:custom_data".NewStats set from storage sbstats:stone SelectedItem.components."minecraft:custom_data".ReforgeStone.stats.common
execute if data storage sbstats:data {PlayerData:{SelectedItem:{components:{"minecraft:custom_data":{Base:{rarity:'UNCOMMON'}}}}}} run data modify storage sbstats:stone Item.components."minecraft:custom_data".NewStats set from storage sbstats:stone SelectedItem.components."minecraft:custom_data".ReforgeStone.stats.uncommon
execute if data storage sbstats:data {PlayerData:{SelectedItem:{components:{"minecraft:custom_data":{Base:{rarity:'RARE'}}}}}} run data modify storage sbstats:stone Item.components."minecraft:custom_data".NewStats set from storage sbstats:stone SelectedItem.components."minecraft:custom_data".ReforgeStone.stats.rare
execute if data storage sbstats:data {PlayerData:{SelectedItem:{components:{"minecraft:custom_data":{Base:{rarity:'EPIC'}}}}}} run data modify storage sbstats:stone Item.components."minecraft:custom_data".NewStats set from storage sbstats:stone SelectedItem.components."minecraft:custom_data".ReforgeStone.stats.epic
execute if data storage sbstats:data {PlayerData:{SelectedItem:{components:{"minecraft:custom_data":{Base:{rarity:'LEGENDARY'}}}}}} run data modify storage sbstats:stone Item.components."minecraft:custom_data".NewStats set from storage sbstats:stone SelectedItem.components."minecraft:custom_data".ReforgeStone.stats.legendary
execute if data storage sbstats:data {PlayerData:{SelectedItem:{components:{"minecraft:custom_data":{Base:{rarity:'MYTHIC'}}}}}} run data modify storage sbstats:stone Item.components."minecraft:custom_data".NewStats set from storage sbstats:stone SelectedItem.components."minecraft:custom_data".ReforgeStone.stats.mythic
execute if data storage sbstats:data {PlayerData:{SelectedItem:{components:{"minecraft:custom_data":{Base:{rarity:'DIVINE'}}}}}} run data modify storage sbstats:stone Item.components."minecraft:custom_data".NewStats set from storage sbstats:stone SelectedItem.components."minecraft:custom_data".ReforgeStone.stats.divine

data modify storage sbstats:reforge SelectedItem.components."minecraft:custom_data".Upgrades.reforge.type set from storage sbstats:stone SelectedItem.components."minecraft:custom_data".ReforgeStone.id
item modify entity @s weapon.mainhand sbstats:stoner
item modify entity @s weapon.mainhand sbstats:reforge_type
item modify entity @s weapon.mainhand sbstats:reforged
function sbstats:reforges/apply_lore

execute if data storage sbstats:data {PlayerData:{SelectedItem:{components:{"minecraft:custom_data":{Base:{rarity:'COMMON'}}}}}} run tellraw @s [{"text": "You reforged your ","color": "green"},{"nbt":"Name","storage":"sbstats:item_name","color": "white","interpret": true},{"text": " into a ","color": "green"},{"nbt":"Name","storage": "sbstats:reforge","color": "white","interpret": false},{"text": " "},{"nbt":"Name","storage": "sbstats:item_name","color": "white","interpret": true}]
execute if data storage sbstats:data {PlayerData:{SelectedItem:{components:{"minecraft:custom_data":{Base:{rarity:'UNCOMMON'}}}}}} run tellraw @s [{"text": "You reforged your ","color": "green"},{"nbt":"Name","storage":"sbstats:item_name","color": "green","interpret": true},{"text": " into a ","color": "green"},{"nbt":"Name","storage": "sbstats:reforge","color": "green","interpret": false},{"text": " "},{"nbt":"Name","storage": "sbstats:item_name","color": "green","interpret": true}]
execute if data storage sbstats:data {PlayerData:{SelectedItem:{components:{"minecraft:custom_data":{Base:{rarity:'RARE'}}}}}} run tellraw @s [{"text": "You reforged your ","color": "green"},{"nbt":"Name","storage":"sbstats:item_name","color": "blue","interpret": true},{"text": " into a ","color": "green"},{"nbt":"Name","storage": "sbstats:reforge","color": "blue","interpret": false},{"text": " "},{"nbt":"Name","storage": "sbstats:item_name","color": "blue","interpret": true}]
execute if data storage sbstats:data {PlayerData:{SelectedItem:{components:{"minecraft:custom_data":{Base:{rarity:'EPIC'}}}}}} run tellraw @s [{"text": "You reforged your ","color": "green"},{"nbt":"Name","storage":"sbstats:item_name","color": "dark_purple","interpret": true},{"text": " into a ","color": "green"},{"nbt":"Name","storage": "sbstats:reforge","color": "dark_purple","interpret": false},{"text": " "},{"nbt":"Name","storage": "sbstats:item_name","color": "dark_purple","interpret": true}]
execute if data storage sbstats:data {PlayerData:{SelectedItem:{components:{"minecraft:custom_data":{Base:{rarity:'LEGENDARY'}}}}}} run tellraw @s [{"text": "You reforged your ","color": "green"},{"nbt":"Name","storage":"sbstats:item_name","color": "gold","interpret": true},{"text": " into a ","color": "green"},{"nbt":"Name","storage": "sbstats:reforge","color": "gold","interpret": false},{"text": " "},{"nbt":"Name","storage": "sbstats:item_name","color": "gold","interpret": true}]
execute if data storage sbstats:data {PlayerData:{SelectedItem:{components:{"minecraft:custom_data":{Base:{rarity:'MYTHIC'}}}}}} run tellraw @s [{"text": "You reforged your ","color": "green"},{"nbt":"Name","storage":"sbstats:item_name","color": "light_purple","interpret": true},{"text": " into a ","color": "green"},{"nbt":"Name","storage": "sbstats:reforge","color": "light_purple","interpret": false},{"text": " "},{"nbt":"Name","storage": "sbstats:item_name","color": "light_purple","interpret": true}]
execute if data storage sbstats:data {PlayerData:{SelectedItem:{components:{"minecraft:custom_data":{Base:{rarity:'DIVINE'}}}}}} run tellraw @s [{"text": "You reforged your ","color": "green"},{"nbt":"Name","storage":"sbstats:item_name","color": "aqua","interpret": true},{"text": " into a ","color": "green"},{"nbt":"Name","storage": "sbstats:reforge","color": "light_purple","interpret": false},{"text": " "},{"nbt":"Name","storage": "sbstats:item_name","color": "aqua","interpret": true}]